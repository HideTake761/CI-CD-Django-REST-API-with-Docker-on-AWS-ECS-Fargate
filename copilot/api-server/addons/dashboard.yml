# CopilotがApp(アプリ名)とEnv(環境名)を自動で渡す
Parameters:
  App:
    Type: String
  Env:
    Type: String
  Name: # サービス名
    Type: String

Resources:
  MyDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub '${App}-${Env}-${Name}-Dashboard' # アプリ名-環境名-サービス名-Dashboard という名前になる
      DashboardBody: !Sub
        - |-
          {
            "widgets": [
              {
                "type": "metric",
                "x": 0,
                "y": 0,
                "width": 12,
                "height": 6,
                "properties": {
                  "metrics": [
                    [ "AWS/ECS", "CPUUtilization", "ClusterName", "${ECSClusterName}", "ServiceName", "${ECSServiceName}" ]
                  ],
                  "period": 300,
                  "stat": "Average",
                  "region": "${AWS::Region}",
                  "title": "CPU Utilization"
                }
              },
              {
                "type": "alarm",
                "x": 0,
                "y": 7,
                "width": 12,
                "height": 3,
                "properties": {
                  "title": "Service Alarms",
                  "alarms": [
                    "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:${App}-${Env}-${Name}-HighCPUUtilization",
                    "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:${App}-${Env}-${Name}-HighMemoryUtilization",
                    "arn:aws:cloudwatch:${AWS::Region}:${AWS::AccountId}:alarm:${App}-${Env}-${Name}-High5xxErrorCount"
                  ]
                }
              }
            ]
          }
        - ECSClusterName: !Sub "${App}-${Env}-Cluster"
          # Copilotが作成したECSクラスターの名前を取得するための定義
          # !Sub:CloudFormationの組み込み関数。文字列の中に変数を埋め込む
          # ${App}-${Env}-ClusterId:Copilotが環境ごとに自動でエクスポートするECSクラスターID
          ECSServiceName: ${Name}
          # Copilotが作成したECSサービスの名前を取得するための定義
